name: Deploy Azure Infrastructure

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'bicep/**'
      - 'parameters/**'
      - '.github/workflows/infrastructure.yml'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AZURE_LOCATION: 'East US'
  RESOURCE_GROUP_NAME: 'rg-dotnet-app-${{ github.run_number }}'
  WEB_APP_NAME: 'webapp-dotnet-${{ github.run_number }}'

jobs:
  validate:
    runs-on: ubuntu-latest
    name: Validate Bicep Templates
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    - name: Install Bicep CLI
      run: |
        az bicep install
        az bicep version
    
    - name: Validate Bicep Template
      run: |
        az deployment sub validate \
          --location "${{ env.AZURE_LOCATION }}" \
          --template-file bicep/deploy.bicep \
          --parameters resourceGroupName="${{ env.RESOURCE_GROUP_NAME }}" \
                      location="${{ env.AZURE_LOCATION }}" \
                      webAppName="${{ env.WEB_APP_NAME }}"

  deploy:
    runs-on: ubuntu-latest
    needs: validate
    name: Deploy Infrastructure
    environment: production
    
    outputs:
      webAppUrl: ${{ steps.deploy.outputs.webAppUrl }}
      webAppName: ${{ steps.deploy.outputs.webAppName }}
      resourceGroupName: ${{ steps.deploy.outputs.resourceGroupName }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    - name: Deploy Bicep Template
      id: deploy
      run: |
        # Deploy the infrastructure
        az deployment sub create \
          --location "${{ env.AZURE_LOCATION }}" \
          --template-file bicep/deploy.bicep \
          --parameters resourceGroupName="${{ env.RESOURCE_GROUP_NAME }}" \
                      location="${{ env.AZURE_LOCATION }}" \
                      webAppName="${{ env.WEB_APP_NAME }}" \
          --name "infrastructure-deployment-${{ github.run_number }}"
        
        # Get outputs
        webAppUrl=$(az deployment sub show \
          --name "infrastructure-deployment-${{ github.run_number }}" \
          --query properties.outputs.webAppUrl.value \
          --output tsv)
        
        webAppName=$(az deployment sub show \
          --name "infrastructure-deployment-${{ github.run_number }}" \
          --query properties.outputs.webAppName.value \
          --output tsv)
        
        resourceGroupName=$(az deployment sub show \
          --name "infrastructure-deployment-${{ github.run_number }}" \
          --query properties.outputs.resourceGroupName.value \
          --output tsv)
        
        echo "webAppUrl=$webAppUrl" >> $GITHUB_OUTPUT
        echo "webAppName=$webAppName" >> $GITHUB_OUTPUT
        echo "resourceGroupName=$resourceGroupName" >> $GITHUB_OUTPUT
        
        echo "âœ… Infrastructure deployed successfully!"
        echo "ğŸŒ Web App URL: $webAppUrl"
        echo "ğŸ“± Web App Name: $webAppName"
        echo "ğŸ“¦ Resource Group: $resourceGroupName"